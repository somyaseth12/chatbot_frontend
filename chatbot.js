const chatMessages=document.getElementById("chatlog"),userInput=document.getElementById("userInput"),sendBtn=document.getElementById("handleSend"),voiceBtn=document.getElementById("voice-btn"),typingElem=document.getElementById("typing"),suggestionsContainer=document.getElementById("suggestions");async function loadSuggestions(){try{let e=await fetch("/suggest",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:""})}),t=await e.json();renderSuggestions(t.suggestions||[])}catch(n){console.error("Suggestion fetch error:",n)}}function renderSuggestions(e){suggestionsContainer.innerHTML="",e.forEach(e=>{let t=document.createElement("button");t.className="suggestion-btn",t.textContent=e,t.onclick=()=>{userInput.value=e,handleSend()},suggestionsContainer.appendChild(t)})}function appendMessage(e,t){let n=document.createElement("div");n.className=e;let s=document.createElement("div");s.className="message-content";let a="bot-msg"===e?'<img src="/static/bot-icon.png" alt="Bot" class="bot-icon">':'<i class="fa-solid fa-user" style="margin-right: 6px; color: #ff5912;"></i>';"bot-msg"===e&&"typing"===t?(n.classList.add("typing-indicator"),s.innerHTML=`
      ${a}
      <span class="typing-dots">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </span>
    `):s.innerHTML=`${a}${t}`,n.appendChild(s),chatMessages.appendChild(n),chatMessages.scrollTop=chatMessages.scrollHeight}async function handleSend(){let e=userInput.value.trim();if(e){appendMessage("user-msg",e),saveToMemory("user",e),userInput.value="",appendMessage("bot-msg","typing");try{let t=await fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e})}),n=await t.json(),s=document.querySelector(".typing-indicator");s&&s.remove(),appendMessage("bot-msg",n.response),saveToMemory("bot",n.response),renderSuggestions(n.suggestions||[])}catch(a){console.error("Fetch error:",a);let o=document.querySelector(".typing-indicator");o&&o.remove(),appendMessage("bot-msg","Sorry, something went wrong.")}}}function saveToMemory(e,t){let n=JSON.parse(localStorage.getItem("chatHistory")||"[]");n.push({role:e,text:t}),localStorage.setItem("chatHistory",JSON.stringify(n))}function loadChatHistory(){let e=JSON.parse(localStorage.getItem("chatHistory")||"[]");e.forEach(({role:e,text:t})=>{appendMessage("bot"===e?"bot-msg":"user-msg",t)})}function clearHistory(){localStorage.removeItem("chatHistory"),chatMessages.innerHTML="";let e="\uD83E\uDD16 Hi! I’m Kodee, your AI assistant. How can I help you today?";appendMessage("bot-msg first-msg",e),saveToMemory("bot",e),loadSuggestions()}function toggleTheme(){document.body.classList.toggle("dark-theme"),localStorage.setItem("theme",document.body.classList.contains("dark-theme")?"dark":"light")}function applyTheme(){let e=localStorage.getItem("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches;"dark"===e||!e&&t?document.body.classList.add("dark-theme"):document.body.classList.remove("dark-theme")}function toggleChatbox(){let e=document.getElementById("chat-container"),t=document.getElementById("chat-popup"),n="block"===e.style.display;e.style.display=n?"none":"block",t.style.display=n?"block":"none",n||(userInput.focus(),loadSuggestions())}if(document.getElementById("close-chat-btn").onclick=()=>{document.getElementById("chat-container").style.display="none",document.getElementById("chat-popup").style.display="block"},"webkitSpeechRecognition"in window){let e=new webkitSpeechRecognition;e.continuous=!1,e.interimResults=!1,e.lang="en-US",voiceBtn.style.display="inline-flex",voiceBtn.addEventListener("click",()=>{e.start(),voiceBtn.classList.add("listening")}),e.onresult=e=>{let t=e.results[0][0].transcript.trim();t?(userInput.value=t,handleSend()):alert("Didn't catch that. Try again.")},e.onend=()=>{voiceBtn.classList.remove("listening")},e.onerror=e=>{console.error("Speech recognition error:",e.error)}}else voiceBtn.style.display="none";const emojiBtn=document.getElementById("emoji-feedback-btn"),modal=document.getElementById("rating-modal"),ratingButtonsDiv=document.getElementById("rating-buttons");let selectedRating=null;for(let i=1;i<=10;i++){let t=document.createElement("button");t.innerText=i,t.style.cssText="width: 32px; height: 32px; border-radius: 5px; border: 1px solid #ccc; background: #c9c9c9;",t.onclick=()=>{selectedRating=i,[...ratingButtonsDiv.children].forEach(e=>{e.style.background="white",e.style.color="black"}),t.style.background="#ff5912",t.style.color="white"},ratingButtonsDiv.appendChild(t)}function closeRatingModal(){modal.style.display="none",selectedRating=null,[...ratingButtonsDiv.children].forEach(e=>{e.style.background="white",e.style.color="black"}),document.getElementById("rating-comment").value=""}function submitRating(){let e=document.getElementById("rating-comment").value;if(!selectedRating)return alert("Please select a rating between 1 and 10.");fetch("/submit-feedback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rating:selectedRating,comment:e})}).then(e=>e.json()).then(()=>{modal.innerHTML="<p style='text-align: center;'>\uD83C\uDF89 Thanks for your feedback!</p>",setTimeout(()=>closeRatingModal(),1500)}).catch(e=>{alert("Error submitting feedback"),console.error(e)})}emojiBtn.onclick=()=>{modal.style.display="block"},window.addEventListener("load",()=>{applyTheme();let e=JSON.parse(localStorage.getItem("chatHistory")||"[]");if(0===e.length){let t="\uD83E\uDD16 Hi! I’m Kodee, Hirebie AI sales expert. How can I help you today?";appendMessage("bot-msg first-msg",t),saveToMemory("bot",t)}else loadChatHistory();loadSuggestions(),setTimeout(()=>{"block"!==document.getElementById("chat-container").style.display&&(document.getElementById("chat-popup").style.display="block")},3e3),userInput.focus()}),sendBtn.addEventListener("click",handleSend),userInput.addEventListener("keypress",e=>{"Enter"===e.key&&handleSend()});